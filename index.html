<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Creator Toolkit - Pro Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Hyper-Modern App Theme */
            --bg-root: #000000;
            --bg-panel: #09090b;
            --bg-card: #18181b;
            --bg-hover: #27272a;
            
            --border-subtle: #27272a;
            --border-focus: #52525b;
            
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            
            --accent-glow: rgba(139, 92, 246, 0.4);
            --gradient-brand: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
            --gradient-card: linear-gradient(180deg, rgba(39, 39, 42, 0) 0%, rgba(39, 39, 42, 0.4) 100%);
            
            --radius-sm: 8px;
            --radius-md: 16px;
            --radius-lg: 24px;
            
            --shadow-float: 0 20px 40px -10px rgba(0,0,0,0.5);
            --transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-root);
            color: var(--text-primary);
            height: 100dvh;
            display: flex;
            overflow: hidden;
            background-image: radial-gradient(circle at 50% -20%, var(--accent-glow), transparent 40%);
        }

        /* --- APP LAYOUT --- */
        #app-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* SIDEBAR (Desktop) */
        .sidebar {
            width: 280px;
            background: rgba(9, 9, 11, 0.6);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            padding: 24px;
            z-index: 50;
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-icon {
            width: 32px;
            height: 32px;
            background: var(--gradient-brand);
            border-radius: 10px;
            display: grid;
            place-items: center;
            font-size: 1rem;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-grow: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 16px;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--bg-hover);
            color: var(--text-primary);
            box-shadow: inset 2px 0 0 #a855f7;
        }

        .nav-icon {
            font-size: 1.25rem;
        }

        /* MAIN CONTENT AREA */
        .main-content {
            flex-grow: 1;
            position: relative;
            overflow-y: auto;
            background: var(--bg-panel);
            border-top-left-radius: var(--radius-lg);
            border-bottom-left-radius: var(--radius-lg);
            box-shadow: -10px 0 30px rgba(0,0,0,0.5);
            scroll-behavior: smooth;
        }

        .view-section {
            display: none;
            padding: 40px 60px;
            max-width: 1000px;
            margin: 0 auto;
            animation: fadeIn 0.4s ease-out forwards;
            opacity: 0;
            transform: translateY(10px);
        }

        .view-section.active {
            display: block;
        }

        @keyframes fadeIn {
            to { opacity: 1; transform: translateY(0); }
        }

        /* TYPOGRAPHY & HEADERS */
        .view-header {
            margin-bottom: 40px;
        }

        .view-title {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -0.03em;
            margin-bottom: 8px;
        }

        .view-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* UI COMPONENTS */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 32px;
            box-shadow: var(--shadow-float);
            background-image: var(--gradient-card);
            margin-bottom: 24px;
        }

        .input-group {
            margin-bottom: 24px;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        select, input, textarea {
            width: 100%;
            background: var(--bg-root);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
            padding: 16px;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 1rem;
            transition: var(--transition);
            appearance: none;
            line-height: 1.5;
        }

        select {
            background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M6 9L12 15L18 9' stroke='%23a1a1aa' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 48px;
        }

        select:focus, textarea:focus {
            outline: none;
            border-color: #a855f7;
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.15);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 16px 24px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-family: inherit;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn-primary {
            background: var(--text-primary);
            color: var(--bg-root);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            background: #e4e4e7;
            box-shadow: 0 10px 20px rgba(255,255,255,0.1);
        }

        .btn-gradient {
            background: var(--gradient-brand);
            color: white;
        }

        .btn-gradient:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(236, 72, 153, 0.3);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border-focus);
            color: var(--text-primary);
        }
        
        .btn-outline:hover:not(:disabled) {
            background: rgba(255,255,255,0.05);
        }

        /* Drag & Drop Area */
        .dropzone {
            border: 2px dashed var(--border-focus);
            border-radius: var(--radius-md);
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: rgba(0,0,0,0.2);
        }

        .dropzone:hover, .dropzone.dragover {
            border-color: #a855f7;
            background: rgba(168, 85, 247, 0.05);
        }

        .drop-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            opacity: 0.7;
        }

        /* Hashtags Grid */
        .hashtag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 24px;
        }

        .tag-pill {
            background: rgba(168, 85, 247, 0.1);
            border: 1px solid rgba(168, 85, 247, 0.3);
            color: #d8b4fe;
            padding: 8px 16px;
            border-radius: 100px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .tag-pill:hover {
            background: #a855f7;
            color: white;
            transform: scale(1.05);
        }

        /* Results / Output States */
        .output-box {
            display: none;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border-subtle);
            animation: fadeIn 0.3s ease;
        }

        .output-box.show {
            display: block;
        }

        .formatted-output {
            background: var(--bg-root);
            padding: 24px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
            font-size: 0.95rem;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .formatted-output strong {
            color: #d8b4fe;
        }

        /* AI Loading Spinner */
        .ai-spinner-container {
            display: none;
            text-align: center;
            padding: 30px;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .ai-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(168, 85, 247, 0.2);
            border-radius: 50%;
            border-top-color: #a855f7;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Time Grid Layout */
        .times-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }

        .time-slot {
            background: rgba(0,0,0,0.4);
            border: 1px solid var(--border-subtle);
            padding: 20px;
            border-radius: var(--radius-sm);
            text-align: center;
        }

        .time-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }

        .time-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--text-primary);
            color: var(--bg-root);
            padding: 12px 24px;
            border-radius: 100px;
            font-weight: 600;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 9999;
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        .toast.visible {
            transform: translateX(-50%) translateY(0);
        }

        /* FLEX UTILS */
        .row {
            display: flex;
            gap: 12px;
        }
        .row > * { flex: 1; }

        /* --- MOBILE ADAPTATION (Bottom Nav App Feel) --- */
        @media (max-width: 768px) {
            #app-container {
                flex-direction: column;
            }

            .main-content {
                border-radius: 0;
                box-shadow: none;
                padding-bottom: 90px; /* Space for bottom nav */
            }

            .view-section {
                padding: 32px 20px;
            }

            .view-title {
                font-size: 2rem;
            }

            .sidebar {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                height: auto;
                flex-direction: row;
                padding: 12px 16px;
                border-right: none;
                border-top: 1px solid var(--border-subtle);
                background: rgba(9, 9, 11, 0.85);
                z-index: 100;
                /* iOS safe area support */
                padding-bottom: calc(12px + env(safe-area-inset-bottom));
            }

            .brand {
                display: none; /* Hide logo on mobile bottom nav */
            }

            .nav-menu {
                flex-direction: row;
                justify-content: space-around;
                width: 100%;
            }

            .nav-item {
                flex-direction: column;
                gap: 4px;
                padding: 8px;
                flex: 1;
                font-size: 0.7rem;
                text-align: center;
                border-radius: 12px;
            }

            .nav-item.active {
                box-shadow: none;
                background: transparent;
                color: #a855f7;
            }

            .nav-item.active .nav-icon {
                transform: scale(1.1);
            }

            .nav-icon {
                font-size: 1.5rem;
                transition: var(--transition);
            }

            .card {
                padding: 24px 20px;
            }
            
            .row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>

    <div id="toast" class="toast">Action Successful</div>

    <div id="app-container">
        
        <!-- SIDEBAR / BOTTOM NAV -->
        <nav class="sidebar">
            <div class="brand">
                <div class="brand-icon">‚ö°</div>
                Toolkit
            </div>
            <div class="nav-menu">
                <!-- NEW AI STUDIO TAB -->
                <div class="nav-item active" onclick="switchView('view-ai', this)">
                    <span class="nav-icon">‚ú®</span>
                    <span>AI Studio</span>
                </div>
                <div class="nav-item" onclick="switchView('view-image', this)">
                    <span class="nav-icon">üñºÔ∏è</span>
                    <span>Converter</span>
                </div>
                <div class="nav-item" onclick="switchView('view-audio', this)">
                    <span class="nav-icon">üéôÔ∏è</span>
                    <span>Voice to Text</span>
                </div>
                <div class="nav-item" onclick="switchView('view-hashtags', this)">
                    <span class="nav-icon">#Ô∏è‚É£</span>
                    <span>Hashtags</span>
                </div>
                <div class="nav-item" onclick="switchView('view-times', this)">
                    <span class="nav-icon">‚è±Ô∏è</span>
                    <span>Post Times</span>
                </div>
            </div>
        </nav>

        <!-- MAIN WORKSPACE -->
        <main class="main-content">
            
            <!-- NEW: AI STUDIO VIEW -->
            <section id="view-ai" class="view-section active">
                <div class="view-header">
                    <h1 class="view-title">‚ú® AI Studio</h1>
                    <p class="view-subtitle">Your personal AI creative director. Generate viral ideas, hooks, and full scripts instantly.</p>
                </div>
                
                <div class="card">
                    <div class="input-group">
                        <label class="input-label">What's your topic or niche?</label>
                        <textarea id="ai-topic-input" rows="3" placeholder="e.g., A day in the life of a software engineer, 5 tips for healthy eating, or 'Tech Gadgets 2026'"></textarea>
                    </div>
                    
                    <div class="row">
                        <button id="btn-ai-ideas" class="btn btn-gradient" onclick="generateAIVideo('ideas')">‚ú® Generate Viral Ideas</button>
                        <button id="btn-ai-script" class="btn btn-outline" onclick="generateAIVideo('script')">‚ú® Write Full Script</button>
                    </div>

                    <div id="ai-loading" class="ai-spinner-container">
                        <div class="ai-spinner"></div>
                        <p style="color: var(--text-secondary); font-weight: 500;">Gemini is brainstorming...</p>
                    </div>

                    <div id="ai-result" class="output-box">
                        <div class="row" style="margin-bottom: 16px; align-items: center; justify-content: space-between;">
                            <label class="input-label" style="margin: 0;">AI Output</label>
                            <button class="btn btn-outline" style="width: auto; padding: 8px 16px; font-size: 0.85rem;" onclick="copyFormattedText('ai-output-text')">Copy to Clipboard</button>
                        </div>
                        <div id="ai-output-text" class="formatted-output"></div>
                    </div>
                </div>
            </section>

            <!-- IMAGE CONVERTER VIEW -->
            <section id="view-image" class="view-section">
                <div class="view-header">
                    <h1 class="view-title">Image Converter</h1>
                    <p class="view-subtitle">Format images locally in milliseconds. Zero server uploads.</p>
                </div>
                
                <div class="card">
                    <div class="dropzone" id="image-upload-area">
                        <div class="drop-icon">üì∏</div>
                        <h3 style="margin-bottom: 8px;">Tap to Upload or Drop File</h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem;">Supports JPG, PNG, WEBP</p>
                        <input type="file" id="image-input" accept="image/*" style="display: none;">
                    </div>
                    
                    <div class="row" style="margin-top: 24px;">
                        <div class="input-group" style="margin: 0; flex: 2;">
                            <label class="input-label">Output Format</label>
                            <select id="image-format">
                                <option value="png">PNG (Lossless)</option>
                                <option value="jpeg">JPEG (Compressed)</option>
                                <option value="webp">WebP (Next-Gen)</option>
                            </select>
                        </div>
                        <div style="flex: 1; display: flex; align-items: flex-end;">
                            <button class="btn btn-gradient" onclick="convertImage()">Convert</button>
                        </div>
                    </div>

                    <div id="image-result" class="output-box">
                        <label class="input-label">Result Preview</label>
                        <canvas id="image-canvas" style="max-width: 100%; border-radius: var(--radius-sm); border: 1px solid var(--border-subtle); background: var(--bg-root); display: block; margin-bottom: 16px;"></canvas>
                        <button class="btn btn-primary" onclick="downloadImage()">‚¨áÔ∏è Download Asset</button>
                    </div>
                </div>
            </section>

            <!-- AUDIO TRANSCRIBER VIEW -->
            <section id="view-audio" class="view-section">
                <div class="view-header">
                    <h1 class="view-title">Voice to Text</h1>
                    <p class="view-subtitle">Live, on-device transcription for scripting and captions.</p>
                </div>
                
                <div class="card">
                    <div style="text-align: center; padding: 20px 0 40px;">
                        <button id="record-btn" onclick="toggleRecording()" class="btn btn-gradient" style="border-radius: 100px; padding: 20px 40px; font-size: 1.1rem; width: auto;">
                            üé§ Start Listening
                        </button>
                    </div>

                    <div style="background: rgba(255, 255, 255, 0.02); border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); padding: 16px; margin-bottom: 24px;">
                        <h4 style="color: var(--text-secondary); margin-bottom: 12px; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">üìÅ Have an audio file?</h4>
                        <div class="row">
                            <a href="https://voicetotextonline.com/" target="_blank" class="btn btn-outline" style="font-size: 0.85rem; padding: 10px; text-decoration: none;">Voice to Text Online ‚Üó</a>
                            <a href="https://synthronai.com/free-audio-transcription-tool/" target="_blank" class="btn btn-outline" style="font-size: 0.85rem; padding: 10px; text-decoration: none;">SynthronAI ‚Üó</a>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">Live Transcript</label>
                        <textarea id="transcription-text" rows="8" placeholder="Speech will appear here in real-time..."></textarea>
                    </div>

                    <div class="row">
                        <button class="btn btn-primary" onclick="copyTranscription()">Copy Text</button>
                        <button class="btn btn-outline" onclick="clearTranscription()">Clear Canvas</button>
                    </div>

                    <!-- NEW: Gemini Enhance Feature -->
                    <div style="margin-top: 24px; border-top: 1px solid var(--border-subtle); padding-top: 24px;">
                        <button id="btn-enhance-transcript" class="btn btn-gradient" onclick="enhanceTranscriptWithAI()">‚ú® Turn into Social Post</button>
                        
                        <div id="audio-ai-loading" class="ai-spinner-container">
                            <div class="ai-spinner"></div>
                            <p style="color: var(--text-secondary); font-weight: 500;">Gemini is writing your post...</p>
                        </div>

                        <div id="audio-ai-result" class="output-box">
                            <div class="row" style="margin-bottom: 16px; align-items: center; justify-content: space-between;">
                                <label class="input-label" style="margin: 0;">AI Generated Caption</label>
                                <button class="btn btn-outline" style="width: auto; padding: 8px 16px; font-size: 0.85rem;" onclick="copyFormattedText('audio-ai-output-text')">Copy to Clipboard</button>
                            </div>
                            <div id="audio-ai-output-text" class="formatted-output"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- HASHTAGS VIEW -->
            <section id="view-hashtags" class="view-section">
                <div class="view-header">
                    <h1 class="view-title">Trending Tags</h1>
                    <p class="view-subtitle">Generate high-performing hashtag clusters based on your niche.</p>
                </div>
                
                <div class="card">
                    <div class="row">
                        <div class="input-group" style="margin: 0; flex: 2;">
                            <label class="input-label">Content Category</label>
                            <select id="niche-select">
                                <option value="fitness">Fitness & Health</option>
                                <option value="food">Food & Cooking</option>
                                <option value="fashion">Fashion & Beauty</option>
                                <option value="tech">Tech & Gaming</option>
                                <option value="travel">Travel & Adventure</option>
                                <option value="business">Business & Finance</option>
                                <option value="art">Art & Design</option>
                                <option value="music">Music & Entertainment</option>
                            </select>
                        </div>
                        <div style="flex: 1; display: flex; align-items: flex-end;">
                            <button class="btn btn-gradient" onclick="generateHashtags()">Generate</button>
                        </div>
                    </div>

                    <div id="hashtag-result" class="output-box">
                        <label class="input-label">Tap tags to copy</label>
                        <div id="hashtag-list" class="hashtag-container"></div>
                    </div>
                </div>
            </section>

            <!-- POSTING TIMES VIEW -->
            <section id="view-times" class="view-section">
                <div class="view-header">
                    <h1 class="view-title">Algorithm Times</h1>
                    <p class="view-subtitle">Statistically optimized posting windows tailored to your timezone.</p>
                </div>
                
                <div class="card">
                    <div class="row">
                        <div class="input-group">
                            <label class="input-label">Platform</label>
                            <select id="platform-select">
                                <option value="tiktok">TikTok</option>
                                <option value="instagram">Instagram Reels</option>
                                <option value="youtube">YouTube Shorts</option>
                                <option value="twitter">X (Twitter)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Your Timezone</label>
                            <select id="timezone-select">
                                <option value="EST">Eastern (EST)</option>
                                <option value="CST">Central (CST)</option>
                                <option value="MST">Mountain (MST)</option>
                                <option value="PST">Pacific (PST)</option>
                                <option value="GMT">GMT (London)</option>
                            </select>
                        </div>
                    </div>
                    
                    <button class="btn btn-gradient" onclick="getPostingTimes()">Analyze Best Times</button>
                    
                    <div id="times-result" class="output-box">
                        <label class="input-label">Suggested Windows</label>
                        <div id="times-grid" class="times-grid"></div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <script>
        // --- Gemini API Setup ---
        const apiKey = "AIzaSyBU8AjoSqgxHbBOk79ikMX37VHDZBtwm88"; // Global API Key for Gemini

        // Helper function for API calls with Exponential Backoff
        async function fetchGeminiWithBackoff(prompt) {
            if (!apiKey || apiKey.trim() === "") {
                throw new Error("API Key is missing. Please add your Gemini API key in the code.");
            }

            // Using the correct gemini-2.0-flash model from your Google AI Studio settings
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };
            
            // Retry delays: 1s, 2s, 4s, 8s, 16s
            const backoffDelays = [1000, 2000, 4000, 8000, 16000];

            for (let attempt = 0; attempt < 6; attempt++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        // Capture the actual error from Google's servers for easier debugging
                        const errorText = await response.text();
                        throw new Error(`API Error ${response.status}: ${errorText}`);
                    }
                    
                    const data = await response.json();
                    if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts) {
                        return data.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error("Invalid response structure from Gemini API.");
                    }
                } catch (error) {
                    if (attempt === 5) {
                        console.error("Gemini API failed after all retries.", error);
                        throw new Error("Unable to connect to AI server. Please try again later.");
                    }
                    // Wait before retrying (exponential backoff)
                    await new Promise(resolve => setTimeout(resolve, backoffDelays[attempt]));
                }
            }
        }

        // Parse markdown bold (**text**) to HTML <strong>text</strong>
        function parseMarkdownToHTML(text) {
            // Escape HTML slightly to be safe
            let html = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            // Parse bold tags
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Ensure double line breaks are preserved
            return html;
        }

        // --- New AI Studio Features ---
        async function generateAIVideo(type) {
            const topicInput = document.getElementById('ai-topic-input').value.trim();
            if (!topicInput) {
                showToast("Please enter a topic or niche first!");
                return;
            }

            // UI state management
            document.getElementById('ai-result').classList.remove('show');
            document.getElementById('ai-loading').style.display = 'flex';
            document.getElementById('btn-ai-ideas').disabled = true;
            document.getElementById('btn-ai-script').disabled = true;

            let prompt = "";
            if (type === 'ideas') {
                prompt = `Act as an expert social media strategist. Generate 3 highly engaging, viral-worthy short-form video ideas for the following topic/niche: "${topicInput}". 
                For each idea, provide:
                1. A catchy Title
                2. A strong Hook (first 3 seconds)
                3. A brief description of the visual/audio concept.
                Keep it concise, actionable, and formatted clearly.`;
            } else if (type === 'script') {
                prompt = `Act as a viral content creator. Write a compelling 30-to-60-second short-form video script for TikTok/Reels about: "${topicInput}".
                Format the response with:
                - Hook (0-3s)
                - Body/Value Proposition
                - Call to Action
                Include visual cues [in brackets] alongside the spoken audio. Make it punchy and engaging.`;
            }

            try {
                const responseText = await fetchGeminiWithBackoff(prompt);
                
                // Display result
                const outputDiv = document.getElementById('ai-output-text');
                outputDiv.innerHTML = parseMarkdownToHTML(responseText);
                
                document.getElementById('ai-loading').style.display = 'none';
                document.getElementById('ai-result').classList.add('show');
                
                // Scroll down to see result
                setTimeout(() => {
                    document.getElementById('ai-result').scrollIntoView({ behavior: 'smooth', block: 'end' });
                }, 100);

            } catch (error) {
                document.getElementById('ai-loading').style.display = 'none';
                showToast(error.message);
                console.error(error);
            } finally {
                document.getElementById('btn-ai-ideas').disabled = false;
                document.getElementById('btn-ai-script').disabled = false;
            }
        }

        // --- New Audio Transcript AI Enhancer ---
        async function enhanceTranscriptWithAI() {
            const transcript = document.getElementById('transcription-text').value.trim();
            if (!transcript) {
                showToast("Record or paste a transcript first!");
                return;
            }

            // UI state management
            document.getElementById('audio-ai-result').classList.remove('show');
            document.getElementById('audio-ai-loading').style.display = 'flex';
            document.getElementById('btn-enhance-transcript').disabled = true;

            const prompt = `Turn the following raw, messy spoken transcript into a highly engaging social media caption (for Instagram or TikTok). 
            Fix any obvious grammar errors from the speech-to-text.
            Add an attention-grabbing hook at the beginning, relevant emojis throughout, and 5-7 targeted hashtags at the end.
            
            Raw Transcript:
            "${transcript}"`;

            try {
                const responseText = await fetchGeminiWithBackoff(prompt);
                
                // Display result
                const outputDiv = document.getElementById('audio-ai-output-text');
                outputDiv.innerHTML = parseMarkdownToHTML(responseText);
                
                document.getElementById('audio-ai-loading').style.display = 'none';
                document.getElementById('audio-ai-result').classList.add('show');

            } catch (error) {
                document.getElementById('audio-ai-loading').style.display = 'none';
                showToast(error.message);
                console.error(error);
            } finally {
                document.getElementById('btn-enhance-transcript').disabled = false;
            }
        }


        // --- UI Navigation Logic ---
        function switchView(viewId, navElement) {
            // Update nav styles
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            navElement.classList.add('active');

            // Switch content sections
            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');
            
            // Scroll to top on mobile when switching views
            document.querySelector('.main-content').scrollTop = 0;
        }

        // --- Global Toast & Copy Logic ---
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('visible');
            setTimeout(() => toast.classList.remove('visible'), 3500);
        }

        function copyFormattedText(elementId) {
            const element = document.getElementById(elementId);
            const textToCopy = element.innerText; // grabs raw text without html tags
            
            // Safe copy method compatible with embedded iframes
            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            textarea.style.position = 'fixed';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                showToast('Text Copied!');
            } catch (err) {
                showToast('Failed to copy');
            }
            
            document.body.removeChild(textarea);
        }

        // --- Image Converter Logic ---
        let uploadedImage = null;
        const imageInput = document.getElementById('image-input');
        const imageUploadArea = document.getElementById('image-upload-area');

        imageUploadArea.addEventListener('click', () => imageInput.click());
        
        imageUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            imageUploadArea.classList.add('dragover');
        });
        
        imageUploadArea.addEventListener('dragleave', () => {
            imageUploadArea.classList.remove('dragover');
        });
        
        imageUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            imageUploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) loadImage(file);
        });

        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) loadImage(file);
        });

        function loadImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    uploadedImage = img;
                    imageUploadArea.innerHTML = `<div class="drop-icon" style="color: #a855f7;">‚úÖ</div><h3 style="margin-bottom: 8px;">${file.name}</h3><p style="color: var(--text-secondary); font-size: 0.9rem;">Ready to convert</p>`;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function convertImage() {
            if (!uploadedImage) return showToast('Upload an image first!');
            const canvas = document.getElementById('image-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = uploadedImage.width;
            canvas.height = uploadedImage.height;
            ctx.drawImage(uploadedImage, 0, 0);
            document.getElementById('image-result').classList.add('show');
            showToast('Conversion Complete');
        }

        function downloadImage() {
            const canvas = document.getElementById('image-canvas');
            const format = document.getElementById('image-format').value;
            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `converted.${format}`;
                a.click();
            }, `image/${format}`);
        }

        // --- Audio Transcriber Logic ---
        let recognition = null;
        let isRecording = false;

        function toggleRecording() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                return showToast('Voice API not supported here.');
            }
            if (!isRecording) startRecording();
            else stopRecording();
        }

        function startRecording() {
            const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRec();
            recognition.continuous = true;
            recognition.interimResults = true;
            
            const textarea = document.getElementById('transcription-text');
            let finalTranscript = textarea.value ? textarea.value + " " : "";

            recognition.onresult = (event) => {
                let interim = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript + ' ';
                    else interim += event.results[i][0].transcript;
                }
                textarea.value = finalTranscript + interim;
            };

            recognition.onend = () => { if (isRecording) recognition.start(); };
            recognition.start();
            isRecording = true;
            
            const btn = document.getElementById('record-btn');
            btn.innerHTML = '‚èπÔ∏è Stop & Save';
            btn.style.background = '#ef4444';
            btn.style.boxShadow = '0 0 20px rgba(239, 68, 68, 0.4)';
        }

        function stopRecording() {
            if (recognition) {
                isRecording = false;
                recognition.stop();
                const btn = document.getElementById('record-btn');
                btn.innerHTML = 'üé§ Start Listening';
                btn.style.background = 'var(--gradient-brand)';
                btn.style.boxShadow = 'none';
                showToast('Recording Stopped');
            }
        }

        function copyTranscription() {
            const text = document.getElementById('transcription-text').value;
            if(!text) return showToast('Nothing to copy');
            
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                showToast('Text Copied!');
            } catch (err) {
                showToast('Failed to copy');
            }
            
            document.body.removeChild(textarea);
        }

        function clearTranscription() {
            document.getElementById('transcription-text').value = '';
            document.getElementById('audio-ai-result').classList.remove('show');
        }

        // --- Hashtag Logic ---
        const hashtagDb = {
            fitness: ['#fitness', '#workout', '#gym', '#fitfam', '#fitspo', '#training', '#exercise', '#health', '#motivation', '#bodybuilding', '#fitnessmotivation', '#gymlife', '#healthy'],
            food: ['#food', '#foodie', '#foodporn', '#instafood', '#delicious', '#yummy', '#cooking', '#foodphotography', '#homemade', '#foodblogger', '#dinner', '#lunch', '#tasty'],
            fashion: ['#fashion', '#style', '#ootd', '#fashionblogger', '#fashionista', '#outfit', '#instafashion', '#beauty', '#model', '#stylish', '#fashionstyle'],
            tech: ['#tech', '#technology', '#gaming', '#gamer', '#pc', '#innovation', '#gadgets', '#ai', '#coding', '#programming', '#developer', '#software'],
            travel: ['#travel', '#wanderlust', '#adventure', '#explore', '#travelgram', '#instatravel', '#travelphotography', '#vacation', '#trip', '#traveling', '#nature'],
            business: ['#business', '#entrepreneur', '#marketing', '#success', '#motivation', '#startup', '#businessowner', '#entrepreneurship', '#smallbusiness', '#hustle', '#money'],
            art: ['#art', '#artist', '#artwork', '#drawing', '#illustration', '#design', '#creative', '#painting', '#sketch', '#instaart', '#artoftheday'],
            music: ['#music', '#musician', '#song', '#sing', '#singer', '#guitar', '#producer', '#dj', '#beats', '#hiphop', '#rap', '#rock', '#pop']
        };

        function generateHashtags() {
            const niche = document.getElementById('niche-select').value;
            const hashtags = hashtagDb[niche];
            const selected = hashtags.sort(() => 0.5 - Math.random()).slice(0, 12);
            
            const list = document.getElementById('hashtag-list');
            list.innerHTML = '';
            
            selected.forEach(tag => {
                const pill = document.createElement('div');
                pill.className = 'tag-pill';
                pill.textContent = tag;
                pill.onclick = () => {
                    const textarea = document.createElement('textarea');
                    textarea.value = tag;
                    textarea.style.position = 'fixed';
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        showToast('Copied: ' + tag);
                    } catch (err) {}
                    document.body.removeChild(textarea);
                };
                list.appendChild(pill);
            });
            document.getElementById('hashtag-result').classList.add('show');
        }

        // --- Times Logic ---
        const timesDb = {
            instagram: { EST: ['9:00 AM', '2:00 PM', '5:00 PM'], CST: ['8:00 AM', '1:00 PM', '4:00 PM'], MST: ['7:00 AM', '12:00 PM', '3:00 PM'], PST: ['6:00 AM', '11:00 AM', '2:00 PM'], GMT: ['2:00 PM', '7:00 PM', '10:00 PM'] },
            tiktok: { EST: ['6:00 AM', '7:00 PM', '9:00 PM'], CST: ['5:00 AM', '6:00 PM', '8:00 PM'], MST: ['4:00 AM', '5:00 PM', '7:00 PM'], PST: ['3:00 AM', '4:00 PM', '6:00 PM'], GMT: ['11:00 AM', '12:00 AM', '2:00 AM'] },
            youtube: { EST: ['3:00 PM', '6:00 PM', '9:00 PM'], CST: ['2:00 PM', '5:00 PM', '8:00 PM'], MST: ['1:00 PM', '4:00 PM', '7:00 PM'], PST: ['12:00 PM', '3:00 PM', '6:00 PM'], GMT: ['8:00 PM', '11:00 PM', '2:00 AM'] },
            twitter: { EST: ['8:00 AM', '12:00 PM', '3:00 PM'], CST: ['7:00 AM', '11:00 AM', '2:00 PM'], MST: ['6:00 AM', '10:00 AM', '1:00 PM'], PST: ['5:00 AM', '9:00 AM', '12:00 PM'], GMT: ['1:00 PM', '5:00 PM', '8:00 PM'] }
        };

        function getPostingTimes() {
            const platform = document.getElementById('platform-select').value;
            const tz = document.getElementById('timezone-select').value;
            const times = timesDb[platform][tz];
            
            const grid = document.getElementById('times-grid');
            grid.innerHTML = '';
            
            const labels = ['Prime Peak', 'Secondary', 'Night Owl'];
            times.forEach((time, i) => {
                grid.innerHTML += `
                    <div class="time-slot">
                        <div class="time-label">${labels[i]}</div>
                        <div class="time-value">${time}</div>
                    </div>`;
            });
            document.getElementById('times-result').classList.add('show');
        }
    </script>
</body>
</html>
